<?php
// === SUPRA KECE CLOAKER ===

// Pastikan folder visits/ ada
$log_dir = __DIR__ . '/visits/';
if (!file_exists($log_dir)) {
    mkdir($log_dir, 0755, true);
}

// --- Fungsi Logging ---
function log_visit($status) {
    global $log_dir;
    $ip   = $_SERVER['REMOTE_ADDR'] ?? '-';
    $ua   = $_SERVER['HTTP_USER_AGENT'] ?? '-';
    $ref  = $_SERVER['HTTP_REFERER'] ?? '-';
    $uri  = $_SERVER['REQUEST_URI'] ?? '-';
    $time = date("Y-m-d H:i:s");

    // GeoIP (kalau modul aktif)
    $country = function_exists('geoip_country_name_by_name')
        ? geoip_country_name_by_name($ip)
        : "Unknown";

    $line = "[$time] [$status] IP:$ip ($country) | UA:$ua | REF:$ref | URI:$uri\n";

    // Pisah log: bot vs human
    $file = (strpos($status, "GOOGLEBOT") !== false)
        ? 'visits-bot-'.date("Y-m-d").'.log'
        : 'visits-human-'.date("Y-m-d").'.log';

    file_put_contents($log_dir.$file, $line, FILE_APPEND);
}

// --- Cek Googlebot ---
function is_google_bot() {
    $ua  = $_SERVER['HTTP_USER_AGENT'] ?? '';
    $ip  = $_SERVER['REMOTE_ADDR'] ?? '';
    $ref = $_SERVER['HTTP_REFERER'] ?? '';

    // Step 1: cek User-Agent
    $agents = [
        "Googlebot",
        "Google-Site-Verification",
        "Google-InspectionTool",
        "Googlebot-Mobile",
        "Googlebot-News"
    ];
    $ua_match = false;
    foreach ($agents as $agent) {
        if (stripos($ua, $agent) !== false) {
            $ua_match = true;
            break;
        }
    }

    // Step 2: cek hostname/IP asli Google
    $hostname = gethostbyaddr($ip);
    $ip_ok = $hostname && preg_match('/\.google(bot)?\.com$/i', $hostname);

    // Step 3: cek referer (opsional → kosong atau dari Google dianggap oke)
    $ref_ok = (empty($ref) || stripos($ref, "google.") !== false);

    // Kalau UA mirip Google tapi IP bukan Google → block
    if ($ua_match && !$ip_ok) {
        log_visit("FAKE BOT BLOCKED");
        header("HTTP/1.1 403 Forbidden");
        exit("Forbidden");
    }

    return $ua_match && $ip_ok && $ref_ok;
}

// === KONFIGURASI ===
$WHITE_DOMAIN = 'https://kshamzah.my.id/';                  // domain putih (canonical)
$AMP_DOMAIN   = 'https://supraslot-kan.pages.dev/';               // domain AMP target
$AMP_SUFFIX   = '';                                         // kosong, jangan pakai .amp

// === EKSEKUSI ===
if (is_google_bot()) {

    log_visit("GOOGLEBOT OK");
    header("Content-Type: text/html; charset=utf-8");

    // Pastikan main.php ada
    if (file_exists('main.php')) {

        // Render isi main.php (kalau ada PHP dinamis jalan di sini)
        ob_start();
        include 'main.php';
        $content = ob_get_clean();

        // === BUAT TAG AMPHTML & CANONICAL FIXED ===
        $inject  = "\n<!-- Suprare Cloaker: injected amphtml -->\n";
        $inject .= "<link rel=\"canonical\" href=\"" . htmlspecialchars($WHITE_DOMAIN, ENT_QUOTES, 'UTF-8') . "\" />\n";
        $inject .= "<link rel=\"amphtml\" href=\"" . htmlspecialchars($AMP_DOMAIN, ENT_QUOTES, 'UTF-8') . "\" />\n";

        // Sisipkan sebelum </head> jika ada, kalau enggak prepend di top
        if (stripos($content, '</head>') !== false) {
            $content = preg_replace('/<\/head>/i', $inject . '</head>', $content, 1);
        } else {
            $content = $inject . $content;
        }

        echo $content;
        exit;

    } else {
        log_visit("BOT 404");
        header("HTTP/1.1 404 Not Found");
        echo "<h1>404 Not Found</h1>";
        exit;
    }

} else {
    // === Human / Fake Bot → konten putih ===
    log_visit("HUMAN");
    if (file_exists('index.txt')) {
        include 'index.txt';
    } else {
        echo "<h1>Welcome</h1><p>Halaman putih tidak ditemukan.</p>";
    }
    exit;
}
